"use client";
import { IProducts } from "@/types/interfaces";
import styles from "./ProductCard.module.css";
import { useRouter } from "next/navigation";
import { useAppDispatch, useAppSelector } from "@/store/store";
import { addToCart, setAddedProduct } from "@/store/slices/cartSlice";
import { MouseEvent, useMemo } from "react";
import { Carousel } from "antd";
import { useCart } from "@/hooks/useCart";
import { useModals } from "@/hooks/useModals";
import { addViewedProduct } from "@/store/slices/viewedSlice";
import {
  addToFavorites,
  deleteFavoritesItem,
} from "@/store/slices/favoritesSlice";
import { isAdmin } from "@/utils/isAdmin";

interface IProps {
  product: IProducts;
  className?: string;
}

function ProductCard({ product, className }: IProps) {
  const dispatch = useAppDispatch();
  const router = useRouter();

  const { cart } = useCart();
  const { favorites } = useAppSelector((state) => state.favorites);
  const { setOpenAddedModal, setOpenDeleteModal, setOpenUpdateModal } =
    useModals();

  const isInCart = cart.some((el) => el.id === product.id);
  const isInFavorites = favorites.some((el) => el.id === product.id);

  const handleAddToCart = (e: MouseEvent<HTMLButtonElement>) => {
    e.stopPropagation();

    dispatch(addToCart({ ...product, count: 1 }));
    setOpenAddedModal(true);
    dispatch(setAddedProduct(product));
  };

  const handleAddToFavorites = () => {
    if (isInFavorites) {
      dispatch(deleteFavoritesItem(product.id));
    } else {
      dispatch(addToFavorites(product));
    }
  };

  const randomRating = useMemo(() => Math.floor(Math.random() * 6), []);

  return (
    <div key={product.id} className={`${styles.card} ${className}`}>
      <div className={styles.cardTop}>
        <div className={styles.rating}>
          {[...Array(5)].map((_, i) => (
            <div
              key={i}
              className={`${randomRating >= i + 1 && styles.active}`}
            >
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M21.947 9.17901C21.8842 8.99388 21.7685 8.83121 21.6142 8.71107C21.46 8.59094 21.2739 8.51861 21.079 8.50301L15.378 8.05001L12.911 2.58901C12.8325 2.41313 12.7047 2.26374 12.5431 2.15887C12.3815 2.05401 12.193 1.99815 12.0004 1.99805C11.8077 1.99794 11.6192 2.05359 11.4575 2.15828C11.2957 2.26296 11.1678 2.41221 11.089 2.58801L8.62203 8.05001L2.92103 8.50301C2.72948 8.51819 2.54636 8.58822 2.39358 8.70475C2.2408 8.82127 2.12482 8.97934 2.05952 9.16004C1.99422 9.34075 1.98236 9.53645 2.02537 9.72372C2.06838 9.91099 2.16443 10.0819 2.30203 10.216L6.51503 14.323L5.02503 20.775C4.97978 20.9703 4.99428 21.1747 5.06665 21.3617C5.13901 21.5486 5.26589 21.7095 5.43083 21.8235C5.59577 21.9374 5.79115 21.9991 5.99161 22.0007C6.19208 22.0022 6.38837 21.9434 6.55503 21.832L12 18.202L17.445 21.832C17.6154 21.9451 17.8162 22.0033 18.0207 21.9988C18.2251 21.9944 18.4232 21.9274 18.5884 21.8069C18.7536 21.6865 18.878 21.5183 18.9448 21.3251C19.0116 21.1318 19.0176 20.9228 18.962 20.726L17.133 14.326L21.669 10.244C21.966 9.97601 22.075 9.55801 21.947 9.17901Z"
                  fill="#DBDBDB"
                />
              </svg>
            </div>
          ))}
        </div>
        <button
          onClick={handleAddToFavorites}
          className={`${styles.like} ${isInFavorites && styles.inFavorites}`}
        >
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M7.5 4C4.4625 4 2 6.4625 2 9.5C2 15 8.5 20 12 21.163C15.5 20 22 15 22 9.5C22 6.4625 19.5375 4 16.5 4C14.64 4 12.995 4.9235 12 6.337C11.4928 5.6146 10.8191 5.02505 10.0358 4.61824C9.25245 4.21144 8.38265 3.99938 7.5 4Z"
              stroke="#585656"
              strokeWidth="2.4"
              strokeLinecap="round"
              strokeLinejoin="round"
            />
          </svg>
        </button>
      </div>
      <h3
        className={styles.title}
        title={product.title}
        onClick={() => {
          dispatch(addViewedProduct(product));
          router.push(`/products/${product.id}`);
        }}
      >
        {product.title}
      </h3>

      <Carousel arrows infinite={false}>
        {product.images.map((img) => (
          <div key={img} className={styles.img}>
            <img src={img} alt="product-image" />
          </div>
        ))}
      </Carousel>

      <div className={styles.details}>
        <p>
          <svg
            width="16"
            height="16"
            viewBox="0 0 16 16"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <circle cx="8" cy="8" r="8" fill="#52D116" />
          </svg>
          Есть в наличии
        </p>
        <p>Гарантия 1 год</p>
      </div>
      <p className={styles.price}>{product.price} $</p>
      <button
        onClick={(e) => !isInCart && handleAddToCart(e)}
        className={`${styles.btn} ${isInCart && styles.btnActive}`}
        disabled={isInCart}
      >
        {isInCart ? (
          <>
            <svg
              width="25"
              height="24"
              viewBox="0 0 25 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <g clip-path="url(#clip0_2654_138)">
                <path
                  d="M1.25 1.5C1.05109 1.5 0.860322 1.57902 0.71967 1.71967C0.579018 1.86032 0.5 2.05109 0.5 2.25C0.5 2.44891 0.579018 2.63968 0.71967 2.78033C0.860322 2.92098 1.05109 3 1.25 3H2.915L3.5165 5.4105L5.7635 17.388C5.79567 17.5599 5.88688 17.7151 6.02137 17.8268C6.15585 17.9386 6.32515 17.9998 6.5 18H8C7.20435 18 6.44129 18.3161 5.87868 18.8787C5.31607 19.4413 5 20.2044 5 21C5 21.7956 5.31607 22.5587 5.87868 23.1213C6.44129 23.6839 7.20435 24 8 24C8.79565 24 9.55871 23.6839 10.1213 23.1213C10.6839 22.5587 11 21.7956 11 21C11 20.2044 10.6839 19.4413 10.1213 18.8787C9.55871 18.3161 8.79565 18 8 18H18.5C17.7044 18 16.9413 18.3161 16.3787 18.8787C15.8161 19.4413 15.5 20.2044 15.5 21C15.5 21.7956 15.8161 22.5587 16.3787 23.1213C16.9413 23.6839 17.7044 24 18.5 24C19.2957 24 20.0587 23.6839 20.6213 23.1213C21.1839 22.5587 21.5 21.7956 21.5 21C21.5 20.2044 21.1839 19.4413 20.6213 18.8787C20.0587 18.3161 19.2957 18 18.5 18H20C20.1749 17.9998 20.3442 17.9386 20.4786 17.8268C20.6131 17.7151 20.7043 17.5599 20.7365 17.388L22.9865 5.388C23.0068 5.27976 23.0029 5.16838 22.9753 5.06178C22.9477 4.95518 22.8969 4.85597 22.8266 4.77121C22.7563 4.68644 22.6682 4.6182 22.5685 4.57133C22.4689 4.52445 22.3601 4.5001 22.25 4.5H4.835L4.2275 2.0685C4.18701 1.90618 4.09342 1.76205 3.9616 1.65904C3.82978 1.55603 3.6673 1.50005 3.5 1.5H1.25ZM9.5 21C9.5 21.3978 9.34196 21.7794 9.06066 22.0607C8.77936 22.342 8.39783 22.5 8 22.5C7.60218 22.5 7.22065 22.342 6.93934 22.0607C6.65804 21.7794 6.5 21.3978 6.5 21C6.5 20.6022 6.65804 20.2206 6.93934 19.9393C7.22065 19.658 7.60218 19.5 8 19.5C8.39783 19.5 8.77936 19.658 9.06066 19.9393C9.34196 20.2206 9.5 20.6022 9.5 21ZM20 21C20 21.3978 19.842 21.7794 19.5607 22.0607C19.2794 22.342 18.8978 22.5 18.5 22.5C18.1022 22.5 17.7206 22.342 17.4393 22.0607C17.158 21.7794 17 21.3978 17 21C17 20.6022 17.158 20.2206 17.4393 19.9393C17.7206 19.658 18.1022 19.5 18.5 19.5C18.8978 19.5 19.2794 19.658 19.5607 19.9393C19.842 20.2206 20 20.6022 20 21ZM17.531 9.531L13.031 14.031C12.9613 14.1008 12.8786 14.1563 12.7875 14.1941C12.6963 14.2319 12.5987 14.2513 12.5 14.2513C12.4014 14.2513 12.3037 14.2319 12.2126 14.1941C12.1214 14.1563 12.0387 14.1008 11.969 14.031L9.719 11.781C9.64927 11.7113 9.59395 11.6285 9.55622 11.5374C9.51848 11.4463 9.49905 11.3486 9.49905 11.25C9.49905 11.1514 9.51848 11.0537 9.55622 10.9626C9.59395 10.8715 9.64927 10.7887 9.719 10.719C9.78873 10.6493 9.87152 10.594 9.96263 10.5562C10.0537 10.5185 10.1514 10.4991 10.25 10.4991C10.3486 10.4991 10.4463 10.5185 10.5374 10.5562C10.6285 10.594 10.7113 10.6493 10.781 10.719L12.5 12.4395L16.469 8.469C16.5387 8.39927 16.6215 8.34395 16.7126 8.30621C16.8037 8.26848 16.9014 8.24905 17 8.24905C17.0986 8.24905 17.1963 8.26848 17.2874 8.30621C17.3785 8.34395 17.4613 8.39927 17.531 8.469C17.6007 8.53873 17.656 8.62152 17.6938 8.71262C17.7315 8.80373 17.7509 8.90138 17.7509 9C17.7509 9.09862 17.7315 9.19627 17.6938 9.28738C17.656 9.37848 17.6007 9.46127 17.531 9.531Z"
                  fill="white"
                />
              </g>
              <defs>
                <clipPath id="clip0_2654_138">
                  <rect
                    width="24"
                    height="24"
                    fill="white"
                    transform="translate(0.5)"
                  />
                </clipPath>
              </defs>
            </svg>
            в корзине
          </>
        ) : (
          <>
            <svg
              width="25"
              height="24"
              viewBox="0 0 25 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <g clipPath="url(#clip0_2537_279)">
                <path
                  d="M1.25 1.5C1.05109 1.5 0.860322 1.57902 0.71967 1.71967C0.579018 1.86032 0.5 2.05109 0.5 2.25C0.5 2.44891 0.579018 2.63968 0.71967 2.78033C0.860322 2.92098 1.05109 3 1.25 3H2.915L3.5165 5.4105L5.7635 17.388C5.79567 17.5599 5.88688 17.7151 6.02137 17.8268C6.15585 17.9386 6.32515 17.9998 6.5 18H8C7.20435 18 6.44129 18.3161 5.87868 18.8787C5.31607 19.4413 5 20.2044 5 21C5 21.7956 5.31607 22.5587 5.87868 23.1213C6.44129 23.6839 7.20435 24 8 24C8.79565 24 9.55871 23.6839 10.1213 23.1213C10.6839 22.5587 11 21.7956 11 21C11 20.2044 10.6839 19.4413 10.1213 18.8787C9.55871 18.3161 8.79565 18 8 18H18.5C17.7044 18 16.9413 18.3161 16.3787 18.8787C15.8161 19.4413 15.5 20.2044 15.5 21C15.5 21.7956 15.8161 22.5587 16.3787 23.1213C16.9413 23.6839 17.7044 24 18.5 24C19.2957 24 20.0587 23.6839 20.6213 23.1213C21.1839 22.5587 21.5 21.7956 21.5 21C21.5 20.2044 21.1839 19.4413 20.6213 18.8787C20.0587 18.3161 19.2957 18 18.5 18H20C20.1749 17.9998 20.3442 17.9386 20.4786 17.8268C20.6131 17.7151 20.7043 17.5599 20.7365 17.388L22.9865 5.388C23.0068 5.27976 23.0029 5.16838 22.9753 5.06178C22.9477 4.95518 22.8969 4.85597 22.8266 4.77121C22.7563 4.68644 22.6682 4.6182 22.5685 4.57133C22.4689 4.52445 22.3601 4.5001 22.25 4.5H4.835L4.2275 2.0685C4.18701 1.90618 4.09342 1.76205 3.9616 1.65904C3.82978 1.55603 3.6673 1.50005 3.5 1.5H1.25ZM9.5 21C9.5 21.3978 9.34196 21.7794 9.06066 22.0607C8.77936 22.342 8.39783 22.5 8 22.5C7.60218 22.5 7.22065 22.342 6.93934 22.0607C6.65804 21.7794 6.5 21.3978 6.5 21C6.5 20.6022 6.65804 20.2206 6.93934 19.9393C7.22065 19.658 7.60218 19.5 8 19.5C8.39783 19.5 8.77936 19.658 9.06066 19.9393C9.34196 20.2206 9.5 20.6022 9.5 21ZM20 21C20 21.3978 19.842 21.7794 19.5607 22.0607C19.2794 22.342 18.8978 22.5 18.5 22.5C18.1022 22.5 17.7206 22.342 17.4393 22.0607C17.158 21.7794 17 21.3978 17 21C17 20.6022 17.158 20.2206 17.4393 19.9393C17.7206 19.658 18.1022 19.5 18.5 19.5C18.8978 19.5 19.2794 19.658 19.5607 19.9393C19.842 20.2206 20 20.6022 20 21ZM14 8.25V10.5H16.25C16.4489 10.5 16.6397 10.579 16.7803 10.7197C16.921 10.8603 17 11.0511 17 11.25C17 11.4489 16.921 11.6397 16.7803 11.7803C16.6397 11.921 16.4489 12 16.25 12H14V14.25C14 14.4489 13.921 14.6397 13.7803 14.7803C13.6397 14.921 13.4489 15 13.25 15C13.0511 15 12.8603 14.921 12.7197 14.7803C12.579 14.6397 12.5 14.4489 12.5 14.25V12H10.25C10.0511 12 9.86032 11.921 9.71967 11.7803C9.57902 11.6397 9.5 11.4489 9.5 11.25C9.5 11.0511 9.57902 10.8603 9.71967 10.7197C9.86032 10.579 10.0511 10.5 10.25 10.5H12.5V8.25C12.5 8.05109 12.579 7.86032 12.7197 7.71967C12.8603 7.57902 13.0511 7.5 13.25 7.5C13.4489 7.5 13.6397 7.57902 13.7803 7.71967C13.921 7.86032 14 8.05109 14 8.25Z"
                  fill="white"
                />
              </g>
              <defs>
                <clipPath id="clip0_2537_279">
                  <rect
                    width="24"
                    height="24"
                    fill="white"
                    transform="translate(0.5)"
                  />
                </clipPath>
              </defs>
            </svg>
            в корзину
          </>
        )}
      </button>
      {isAdmin() && (
        <div className={styles.adminActions}>
          <button
            onClick={() => {
              dispatch(setAddedProduct(product));
              setOpenDeleteModal(true);
            }}
            className={styles.del}
          >
            Удалить
          </button>
          <button
            onClick={() => {
              setOpenUpdateModal(true);
              dispatch(setAddedProduct(product));
            }}
            className={styles.edit}
          >
            Изменить
          </button>
        </div>
      )}
    </div>
  );
}

export default ProductCard;
